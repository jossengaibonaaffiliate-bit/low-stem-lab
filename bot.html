<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pete | Growth Partner AI</title>
    <!-- Modern Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10B981;
            --bg-dark: #05050A;
            --text-main: #FFFFFF;
            --text-muted: #94A3B8;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            text-align: center;
            z-index: 10;
        }

        .avatar-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 40px;
        }

        .pete-avatar {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .pete-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        p {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Greeting -->
        <h1 id="greeting">Hi there,</h1>
        <!-- Simple Status Text (Connecting...) -->
        <p id="p-text">Connecting to Pete...</p>

        <div class="avatar-container">
            <div class="pete-avatar" id="avatar">
                <img id="p-img" src="assets/pete_avatar.jpg" alt="Pete" style="display:block;">
            </div>
        </div>
    </div>

    <script type="module">
        import { Conversation } from 'https://esm.sh/@elevenlabs/client';

        const AGENT_ID = 'agent_0801kepwdkh9ewsay80c8g0ptr1h';
        let connected = false;
        let isConnecting = false;

        const urlParams = new URLSearchParams(window.location.search);

        // Strict approach: Trust the URL params implicitly
        const fName = urlParams.get('first_name') || 'there';
        const lName = urlParams.get('last_name') || '';

        // Safe element selection
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.innerText = `Hi ${fName},`;

        const dynamicVars = {
            first_name: fName,
            last_name: lName,
            email: urlParams.get('email') || 'Unknown',
            booking_goal: urlParams.get('goal') || 'scale your production'
        };

        async function startPete() {
            if (connected || isConnecting) return;
            isConnecting = true;

            // Security Check
            if (!window.isSecureContext) {
                console.error("Context is not secure (HTTPS required).");
                alert("HTTPS Required for Microphone Access");
                isConnecting = false;
                return;
            }

            try {
                // Request microphone access (required for audio to play back)
                await navigator.mediaDevices.getUserMedia({ audio: true });

                const pText = document.getElementById('p-text');
                if (pText) pText.innerText = "Syncing...";

                await new Promise(resolve => setTimeout(resolve, 2000));

                await Conversation.startSession({
                    agentId: AGENT_ID,
                    connectionType: 'webrtc',
                    dynamicVariables: dynamicVars,
                    onConnect: () => {
                        connected = true;
                        isConnecting = false;

                        // Update UI - Minimalist: Hide status text when connected
                        if (pText) pText.style.visibility = 'hidden';
                    },
                    onDisconnect: () => {
                        connected = false;
                        if (pText) {
                            pText.style.visibility = 'visible';
                            pText.innerText = "Session Ended";
                        }
                    },
                    onError: (err) => {
                        console.error("ElevenLabs Error:", err);
                        isConnecting = false;
                        if (pText) pText.innerText = "Connection Failed. Retrying...";
                    }
                });
            } catch (err) {
                isConnecting = false;
                console.error("Setup Error:", err);
                const pText = document.getElementById('p-text');

                // Distinguish between NotAllowed (Permission) and NotFound (No Mic)
                if (err.name === 'NotAllowedError') {
                    if (pText) pText.innerText = "Microphone Permission Denied";
                } else {
                    if (pText) pText.innerText = "Microphone Access Error";
                }

                // Retry slowly
                setTimeout(startPete, 5000);
            }
        }

        // Auto-start
        window.addEventListener('click', () => {
            if (!connected && !isConnecting) startPete();
        });

        window.onload = () => {
            startPete();
        };
    </script>
</body>

</html>